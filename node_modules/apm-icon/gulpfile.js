var gulp = require('gulp');
var rename = require('gulp-rename');
var replace = require('gulp-replace');
var name = require('./package.json').name;
var del = require('del');

gulp.task('copy', ['replace'], function () {
  return gulp.src('./iconfont.css')
            .pipe( replace(/\.\/(iconfont\.)/g, 'node_modules/'+ name +'/$1') )
            .pipe( rename({
              extname: '.scss'
            }) )
            .pipe( gulp.dest('./') );
});

gulp.task('replace', function () {
  return gulp.src('./iconfont.css')
            .pipe( replace(/url\(\'(iconfont)/g, "url('./fonts/$1") )
            .pipe( replace(/(\.icon,)/, '') )
            .pipe( replace(/(\.iconfont[\s]*\{)/, '.icon,\n$1') )
            .pipe( replace(/\n{3,}/g, '\n\n'))
            .pipe( gulp.dest('./') );
});

gulp.task('replace:unicode-html', function () {
  return gulp.src('./demo_unicode.html')
            .pipe( replace(/url\(\'(iconfont)/g, "url('./fonts/$1") )
            .pipe( gulp.dest('./') );
});

gulp.task('copy:font-file', function () {
  return gulp.src('iconfont.?(woff|woff2|svg|eot|ttf)')
            .pipe( gulp.dest('./fonts') );
});

gulp.task('default', ['replace', 'copy', 'copy:font-file', 'replace:unicode-html'], function () {
  return del('iconfont.?(woff|woff2|svg|eot|ttf)');
});
